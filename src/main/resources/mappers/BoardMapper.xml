<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spoons.sehaehae.board.dao.BoardMapper">

    <!-- 공지사항 -->
    <resultMap id="generalNoticeResultMap" type="com.spoons.sehaehae.board.dto.NoticeDTO">
        <id property="no" column="NOTICE_NO"/>
        <result property="title" column="NOTICE_TITLE"/>
        <result property="body" column="NOTICE_BODY"/>
        <result property="createdDate" column="NOTICE_CREATED_DATE"/>
        <result property="count" column="NOTICE_COUNT"/>
        <result property="noticeWriterNo" column="NOTICE_WRITER_NO"/>
        <result property="status" column="NOTICE_STATUS"/>
        <result property="deleteDate" column="NOTICE_DELETE_DATE"/>
        <result property="modifiedDate" column="NOTICE_MODIFIED_DATE"/>

        <association property="writer" resultMap="memberResultMap"/>
    </resultMap>

    <resultMap id="memberResultMap" type="com.spoons.sehaehae.member.dto.MemberDTO">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberId" column="ID"/>
        <result property="memberPwd" column="PASSWORD"/>
        <result property="name" column="NAME"/>
        <result property="nickname" column="NICKNAME"/>
        <result property="phone" column="PHONE_NUMBER"/>
        <result property="birthday" column="BIRTHDAY"/>
        <result property="gender" column="GENDER"/>
        <result property="zipCode" column="ZIPCODE"/>
        <result property="subscriptionDate" column="SUBSCRIPTION_DATE"/>
        <result property="profilePhoto" column="PROFILE_PHOTO"/>
        <result property="referralCode" column="REFERRAL_CODE"/>
        <result property="memberStatus" column="MEMBER_STATUS"/>
        <result property="address1" column="ADDRESS1"/>
        <result property="address2" column="ADDRESS2"/>
    </resultMap>

    <!-- 자주하는 질문 -->
    <resultMap id="qnaBoardResultMap" type="com.spoons.sehaehae.board.dto.QnaDTO">
        <id property="no" column="QNA_NO"/>
        <result property="categoryNo" column="CATEGORY_NO"/>
        <result property="adminNo" column="ADMIN_NO"/>
        <result property="title" column="QNA_TITLE"/>
        <result property="body" column="QNA_BODY"/>
        <result property="createdDate" column="QNA_CREATED_DATE"/>
        <result property="status" column="QNA_STATUS"/>
        <result property="modifiedDate" column="QNA_MODIFIED_DATE"/>
        <result property="deleteDate" column="QNA_DELETE_DATE"/>

        <association property="writer" resultMap="memberResultMap"/>
        <association property="category" resultMap="categoryResultMap"/>
    </resultMap>

    <resultMap id="categoryResultMap" type="com.spoons.sehaehae.board.dto.BoardCategoryDTO">
        <id property="no" column="CATEGORY_NO"/>
        <result property="name" column="CATEGORY_NAME"/>
    </resultMap>

    <!-- 후기 게시판 -->
    <resultMap id="reviewBoardResultMap" type="com.spoons.sehaehae.board.dto.ReviewDTO">
        <id property="no" column="REVIEW_NO"/>
        <result property="title" column="REVIEW_TITLE"/>
        <result property="body" column="REVIEW_BODY"/>
        <result property="count" column="REVIEW_COUNT"/>
        <result property="createdDate" column="REVIEW_CREATED_DATE"/>
        <result property="modifiedDate" column="REVIEW_MODIFIED_DATE"/>
        <result property="memberNo" column="MEMBER_NO"/>
        <result property="status" column="REVIEW_STATUS"/>
        <result property="deleteDate" column="REVIEW_DELETE_DATE"/>
        <result property="orderCode" column="ORDER_CODE"/>
        <result property="rating" column="RATING"/>

        <association property="writer" resultMap="memberResultMap"/>
        <collection property="attachmentList" resultMap="attachmentResultMap"/>
        <collection property="replyList" resultMap="replyResultMap"/>
    </resultMap>

    <resultMap id="replyResultMap" type="com.spoons.sehaehae.board.dto.ReplyDTO">
        <id property="no" column="REPLY_NO"/>
        <result property="reviewNo" column="REVIEW_NO"/>
        <result property="body" column="REVIEW_NO"/>
        <result property="date" column="REVIEW_NO"/>
        <result property="status" column="REVIEW_NO"/>
        <result property="deleteDate" column="REVIEW_NO"/>
        <result property="modifiedDate" column="REVIEW_NO"/>

        <association property="writer" javaType="com.spoons.sehaehae.member.dto.MemberDTO">
            <id property="memberNo" column="MEMBER_NO"/>
            <result property="memberId" column="ID"/>
            <result property="memberPwd" column="PASSWORD"/>
            <result property="name" column="NAME"/>
            <result property="nickname" column="NICKNAME"/>
            <result property="phone" column="PHONE_NUMBER"/>
            <result property="birthday" column="BIRTHDAY"/>
            <result property="gender" column="GENDER"/>
            <result property="zipCode" column="ZIPCODE"/>
            <result property="subscriptionDate" column="SUBSCRIPTION_DATE"/>
            <result property="profilePhoto" column="PROFILE_PHOTO"/>
            <result property="referralCode" column="REFERRAL_CODE"/>
            <result property="memberStatus" column="MEMBER_STATUS"/>
            <result property="address1" column="ADDRESS1"/>
            <result property="address2" column="ADDRESS2"/>
        </association>
    </resultMap>

    <resultMap id="attachmentResultMap" type="com.spoons.sehaehae.board.dto.AttachmentDTO">
        <id property="no" column="ATTACHED_FILE_NO"/>
        <result property="name" column="ATTACHED_FILE_NAME"/>
        <result property="route" column="ATTACHED_FILE_NAME"/>
        <result property="saveName" column="ATTACHED_FILE_NAME"/>
        <result property="extension" column="ATTACHED_FILE_NAME"/>
        <result property="size" column="ATTACHED_FILE_NAME"/>
        <result property="ex" column="ATTACHED_FILE_NAME"/>
        <result property="reviewNo" column="ATTACHED_FILE_NAME"/>
    </resultMap>

    <!-- 공지사항 -->
    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
        COUNT(*)
        FROM TBL_NOTICE A
        <where>
            <if test="searchCondition == 'title'">
                A.NOTICE_TITLE LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'content'">
                A.NOTICE_BODY LIKE '%' || #{ searchValue } || '%'
            </if>
            AND A.NOTICE_STATUS = 'Y'
        </where>
    </select>

    <select id="selectNoticeList" resultMap="generalNoticeResultMap">
        SELECT
        A.NOTICE_NO
        , A.NOTICE_TITLE
        , A.NOTICE_BODY
        , A.NOTICE_CREATED_DATE
        , A.NOTICE_COUNT
        , A.NOTICE_WRITER_NO
        , E.NICKNAME
        , A.NOTICE_STATUS
        , A.NOTICE_DELETE_DATE
        , A.NOTICE_MODIFIED_DATE
        FROM (SELECT
                ROWNUM RNUM
                , B.NOTICE_NO
                , B.NOTICE_TITLE
                , B.NOTICE_BODY
                , B.NOTICE_CREATED_DATE
                , B.NOTICE_COUNT
                , B.NOTICE_WRITER_NO
                , B.NOTICE_STATUS
                , B.NOTICE_DELETE_DATE
                , B.NOTICE_MODIFIED_DATE
                FROM(SELECT
                        C.NOTICE_NO
                        , C.NOTICE_TITLE
                        , C.NOTICE_BODY
                        , C.NOTICE_CREATED_DATE
                        , C.NOTICE_COUNT
                        , C.NOTICE_WRITER_NO
                        , C.NOTICE_STATUS
                        , C.NOTICE_DELETE_DATE
                        , C.NOTICE_MODIFIED_DATE
                        FROM TBL_NOTICE C
        <if test="searchCondition == 'writer'">
            JOIN TBL_MEMBER D ON(C.NOTICE_WRITER_NO == D.MEMBER_NO)
        </if>
        <where>
            <if test="searchCondition == 'writer'">
                D.NICKNAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                C.NOTICE_TITLE LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'body'">
                C.NOTICE_BODY LIKE '%' || #{ searchValue } || '%'
            </if>
            AND C.NOTICE_STATUS = 'Y'
        </where>
        ORDER BY C.NOTICE_NO DESC
        ) B
        <![CDATA[
                  WHERE ROWNUM <= #{ endRow }
                  ]]>
        ) A
        JOIN TBL_MEMBER E ON(A.NOTICE_WRITER_NO = E.MEMBER_NO)
        WHERE A.RNUM >= #{ startRow }
        ORDER BY 1 DESC
    </select>

    <update id="incrementNoticeCount">
        UPDATE
        TBL_NOTICE A
        SET A.NOTICE_COUNT = A.NOTICE_COUNT + 1
        WHERE A.NOTICE_NO = #{ no }
    </update>

    <select id="selectNoticeDetail" resultMap="generalNoticeResultMap">
        SELECT
        A.NOTICE_NO
        , A.NOTICE_TITLE
        , A.NOTICE_BODY
        , A.NOTICE_CREATED_DATE
        , A.NOTICE_COUNT
        , B.MEMBER_NO
        , B.NICKNAME
        FROM TBL_NOTICE A
        JOIN TBL_MEMBER B ON (A.NOTICE_WRITER_NO = B.MEMBER_NO)
        WHERE A.NOTICE_STATUS = 'Y'
        AND A.NOTICE_NO = #{ no }
    </select>

    <insert id="insertNotice">
        INSERT
        INTO TBL_NOTICE A
        (
        A.NOTICE_NO
        , A.NOTICE_TITLE
        , A.NOTICE_BODY
        , A.NOTICE_CREATED_DATE
        , A.NOTICE_COUNT
        , A.NOTICE_WRITER_NO
        , A.NOTICE_STATUS
        )
        VALUES
        (
        SEQ_NOTICE_NO.NEXTVAL
        , #{ title }
        , #{ body }
        , SYSDATE
        , 0
        , 23
        <!--        , #{ writer.memberNo }-->
        , 'Y'
        )
    </insert>

    <update id="updateNotice">
        UPDATE TBL_NOTICE
        SET NOTICE_TITLE = #{ title }
        , NOTICE_BODY = #{ body }
        , NOTICE_MODIFIED_DATE = SYSDATE
        WHERE NOTICE_NO = #{ no }
    </update>

    <update id="deleteNotice">
        UPDATE TBL_NOTICE
        SET NOTICE_STATUS = 'N'
        WHERE NOTICE_STATUS = 'Y'
        AND NOTICE_NO = #{ no }
    </update>

    <!-- 자주하는 질문 -->
    <select id="qnaTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
        COUNT(*)
        FROM TBL_QNA A
        <if test="searchCondition == 'category'">
            JOIN TBL_BOARD_CATEGORY B ON(A.CATEGORY_NO = B.CATEGORY_NO)
        </if>
        <where>
            <if test="searchCondition == 'category'">
                B.CATEGORY_NAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                A.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'content'">
                A.QNA_BODY LIKE '%' || #{ searchValue } || '%'
            </if>
            AND A.QNA_STATUS = 'Y'
        </where>
    </select>

    <select id="selectQnaList" resultMap="qnaBoardResultMap">
        SELECT
        A.QNA_NO
        , A.CATEGORY_NO
        , D.CATEGORY_NAME
        , A.ADMIN_NO
        , E.NICKNAME
        , A.QNA_TITLE
        , A.QNA_BODY
        , A.QNA_CREATED_DATE
        , A.QNA_STATUS
        , A.QNA_MODIFIED_DATE
        , A.QNA_DELETE_DATE
        FROM (SELECT
        ROWNUM RNUM
        , B.QNA_NO
        , B.CATEGORY_NO
        , B.ADMIN_NO
        , B.QNA_TITLE
        , B.QNA_BODY
        , B.QNA_CREATED_DATE
        , B.QNA_STATUS
        , B.QNA_MODIFIED_DATE
        , B.QNA_DELETE_DATE
        FROM(SELECT
        C.QNA_NO
        , C.CATEGORY_NO
        , C.ADMIN_NO
        , C.QNA_TITLE
        , C.QNA_BODY
        , C.QNA_CREATED_DATE
        , C.QNA_STATUS
        , C.QNA_MODIFIED_DATE
        , C.QNA_DELETE_DATE
        FROM TBL_QNA C
        <if test="searchCondition == 'category'">
            JOIN TBL_BOARD_CATEGORY D ON(C.CATEGORY_NO = D.CATEGORY_NO)
        </if>
        <where>
            <if test="searchCondition == 'category'">
                <!--                D.CATEGORY_NAME = #{ searchValue }-->
                D.CATEGORY_NAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                C.QNA_TITLE LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'body'">
                C.QNA_BODY LIKE '%' || #{ searchValue } || '%'
            </if>
            AND C.QNA_STATUS = 'Y'
        </where>
        ORDER BY C.QNA_NO DESC
        ) B
        <![CDATA[
                  WHERE ROWNUM <= #{ endRow }
                  ]]>
        ) A
        JOIN TBL_BOARD_CATEGORY D ON (A.CATEGORY_NO = D.CATEGORY_NO)
        JOIN TBL_MEMBER E ON(A.ADMIN_NO = E.MEMBER_NO)
        WHERE A.RNUM >= #{ startRow }
        ORDER BY 1 DESC
    </select>

    <select id="selectQnaView" resultMap="qnaBoardResultMap">
        SELECT
        A.QNA_NO
        , C.CATEGORY_NAME
        , B.MEMBER_NO
        , B.NICKNAME
        , A.QNA_TITLE
        , A.QNA_BODY
        , A.QNA_CREATED_DATE
        FROM TBL_QNA A
        JOIN TBL_MEMBER B ON (A.ADMIN_NO = B.MEMBER_NO)
        JOIN TBL_BOARD_CATEGORY C ON (A.CATEGORY_NO = C.CATEGORY_NO)
        WHERE A.QNA_STATUS = 'Y'
        AND A.QNA_NO = #{ no }
    </select>

    <insert id="insertQna">
        INSERT
        INTO TBL_QNA A
        (
        A.QNA_NO
        , A.CATEGORY_NO
        , A.ADMIN_NO
        , A.QNA_TITLE
        , A.QNA_BODY
        , A.QNA_CREATED_DATE
        , A.QNA_STATUS
        )
        VALUES
        (
        SEQ_QNA_NO.NEXTVAL
        , #{ categoryNo }
        , 23
        , #{ title }
        , #{ body }
        , SYSDATE
        , 'Y'
        )
    </insert>

    <update id="updateQna">
        UPDATE TBL_QNA
        SET CATEGORY_NO = #{ categoryNo }
        , QNA_TITLE = #{ title }
        , QNA_BODY = #{ body }
        , QNA_MODIFIED_DATE = SYSDATE
        WHERE QNA_NO = #{ no }
    </update>

    <update id="deleteQna">
        UPDATE TBL_QNA
        SET QNA_STATUS = 'N'
        WHERE QNA_STATUS = 'Y'
        AND QNA_NO = #{ no }
    </update>

</mapper>