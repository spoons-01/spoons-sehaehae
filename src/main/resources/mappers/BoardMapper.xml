<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spoons.sehaehae.board.dao.BoardMapper">

    <resultMap id="generalNoticeResultMap" type="com.spoons.sehaehae.board.dto.NoticeDTO">
        <id property="no" column="NOTICE_NO"/>
        <result property="title" column="NOTICE_TITLE"/>
        <result property="body" column="NOTICE_BODY"/>
        <result property="createdDate" column="NOTICE_CREATED_DATE"/>
        <result property="count" column="NOTICE_COUNT"/>
        <result property="noticeWriterNo" column="NOTICE_WRITER_NO"/>
        <result property="status" column="NOTICE_STATUS"/>
        <result property="deleteDate" column="NOTICE_DELETE_DATE"/>
        <result property="modifiedDate" column="NOTICE_MODIFIED_DATE"/>

        <association property="writer" resultMap="memberResultMap"/>
    </resultMap>

    <resultMap id="memberResultMap" type="com.spoons.sehaehae.member.dto.MemberDTO">
        <id property="memberNo" column="MEMBER_NO"/>
        <result property="memberId" column="ID"/>
        <result property="memberPwd" column="PASSWORD"/>
        <result property="name" column="NAME"/>
        <result property="nickname" column="NICKNAME"/>
        <result property="phone" column="PHONE_NUMBER"/>
        <result property="birthday" column="BIRTHDAY"/>
        <result property="gender" column="GENDER"/>
        <result property="address" column="ADDRESS"/>
        <result property="subscriptionDate" column="SUBSCRIPTION_DATE"/>
        <result property="profilePhoto" column="PROFILE_PHOTO"/>
        <result property="referralCode" column="REFERRAL_CODE"/>
        <result property="memberStatus" column="MEMBER_STATUS"/>

    </resultMap>

    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
               COUNT(*)
          FROM TBL_NOTICE
    </select>

    <select id="selectNoticeList" resultMap="generalNoticeResultMap">
        SELECT
               A.NOTICE_NO
             , A.NOTICE_TITLE
             , A.NOTICE_BODY
             , A.NOTICE_CREATED_DATE
             , A.NOTICE_COUNT
             , A.NOTICE_WRITER_NO
             , E.NICKNAME
             , A.NOTICE_STATUS
             , A.NOTICE_DELETE_DATE
             , A.NOTICE_MODIFIED_DATE
          FROM (SELECT
                       ROWNUM RNUM
                     , B.NOTICE_NO
                     , B.NOTICE_TITLE
                     , B.NOTICE_BODY
                     , B.NOTICE_CREATED_DATE
                     , B.NOTICE_COUNT
                     , B.NOTICE_WRITER_NO
                     , B.NOTICE_STATUS
                     , B.NOTICE_DELETE_DATE
                     , B.NOTICE_MODIFIED_DATE
                FROM(SELECT
                              C.NOTICE_NO
                            , C.NOTICE_TITLE
                            , C.NOTICE_BODY
                            , C.NOTICE_CREATED_DATE
                            , C.NOTICE_COUNT
                            , C.NOTICE_WRITER_NO
                            , C.NOTICE_STATUS
                            , C.NOTICE_DELETE_DATE
                            , C.NOTICE_MODIFIED_DATE
                        FROM TBL_NOTICE C
        <if test="searchCondition == 'writer'">
            JOIN TBL_MEMBER D ON(C.NOTICE_WRITER_NO == D.MEMBER_NO)
        </if>
        <where>
            <if test="searchCondition == 'writer'">
                D.NICKNAME LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'title'">
                C.NOTICE_TITLE LIKE '%' || #{ searchValue } || '%'
            </if>
            <if test="searchCondition == 'content'">
                C.NOTICE_BODY LIKE '%' || #{ searchValue } || '%'
            </if>
            AND C.NOTICE_STATUS = 'Y'
        </where>
        ORDER BY C.NOTICE_NO DESC
        ) B
        <![CDATA[
                  WHERE ROWNUM <= #{ endRow }
                  ]]>
        ) A
        JOIN TBL_MEMBER E ON(A.NOTICE_WRITER_NO = E.MEMBER_NO)
        WHERE A.RNUM >= #{ startRow }
        ORDER BY 1 DESC
    </select>

    <update id="incrementNoticeCount">
        UPDATE
            TBL_NOTICE A
          SET A.NOTICE_COUNT = A.NOTICE_COUNT + 1
         WHERE A.NOTICE_NO = #{ no }
    </update>

    <select id="selectNoticeDetail" resultMap="generalNoticeResultMap">
        SELECT
              A.NOTICE_NO
            , A.NOTICE_TITLE
            , A.NOTICE_BODY
            , A.NOTICE_CREATED_DATE
            , A.NOTICE_COUNT
            , B.MEMBER_NO
            , B.NICKNAME
        FROM TBL_NOTICE A
        JOIN TBL_MEMBER B ON (A.NOTICE_WRITER_NO = B.MEMBER_NO)
        WHERE A.NOTICE_STATUS = 'Y'
         AND A.NOTICE_NO = #{ no }
    </select>

</mapper>